name: Compass Deployment Tracking

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  track-deployment:
    name: Send Deployment Event to Compass
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Send Deployment Event
        env:
          ATLASSIAN_SITE: ${{ secrets.ATLASSIAN_SITE }}
          ATLASSIAN_USER_EMAIL: ${{ secrets.ATLASSIAN_USER_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from base64 import b64encode
          from datetime import datetime

          site = os.getenv('ATLASSIAN_SITE')
          email = os.getenv('ATLASSIAN_USER_EMAIL')
          token = os.getenv('ATLASSIAN_API_TOKEN')
          environment = os.getenv('ENVIRONMENT', 'production')

          # Auth
          auth_string = f"{email}:{token}"
          auth_b64 = b64encode(auth_string.encode('ascii')).decode('ascii')

          headers = {
              'Authorization': f'Basic {auth_b64}',
              'Content-Type': 'application/json',
              'Accept': 'application/json'
          }

          # Send deployment event
          url = f"https://{site}/gateway/api/compass/v1/events"

          event = {
              "cloudId": "CLOUD_ID_HERE",  # Replace with actual cloud ID
              "event": {
                  "deployment": {
                      "state": "SUCCESSFUL",
                      "environment": {
                          "type": environment
                      },
                      "sequenceNumber": int(datetime.utcnow().timestamp()),
                      "updateSequenceNumber": int(datetime.utcnow().timestamp())
                  }
              }
          }

          response = requests.post(url, headers=headers, json=event, timeout=10)

          if response.status_code in [200, 201, 204]:
              print(f"✅ Deployment event sent: {environment} - SUCCESSFUL")
          else:
              print(f"❌ Failed: {response.status_code} - {response.text}")

          EOF

      - name: Create GitHub Deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: '${{ github.event.inputs.environment || 'production' }}',
              auto_merge: false,
              required_contexts: []
            });

            if (deployment.data) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: 'success',
                description: 'Deployed successfully'
              });
            }
